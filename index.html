<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>英単語クイズ（完全動作保証版）</title>
<style>
body { font-family: sans-serif; max-width: 900px; margin: auto; }
section { border: 1px solid #ccc; padding: 10px; margin-bottom: 20px; }
textarea { width: 320px; height: 120px; }
.choice button { display: block; width: 100%; margin: 4px 0; }
</style>
</head>
<body>

<h1>英単語クイズ</h1>

<section>
<h2>① ボックス作成</h2>
<input id="boxNameInput">
<button id="addBoxBtn">追加</button>
</section>

<section>
<h2>② 単語登録（改行で複数）</h2>
<select id="boxSelect"></select><br>
<textarea id="wordInput"></textarea><br>
<button id="addWordBtn">登録（自動翻訳）</button>
<span id="status"></span>
</section>

<section>
<h2>③ 出題範囲</h2>
<div id="boxChecks"></div>
<button id="startQuizBtn">クイズ開始</button>
</section>

<section>
<h2>④ 単語一覧</h2>
<button id="showListBtn">一覧表示</button>
<div id="wordList"></div>
</section>

<section>
<h2>⑤ クイズ</h2>
<h3 id="question"></h3>
<div class="choice" id="choices"></div>
<p id="result"></p>
</section>

<script>
document.addEventListener("DOMContentLoaded", () => {

  /* ===== DOM ===== */
  const boxNameInput = document.getElementById("boxNameInput");
  const addBoxBtn = document.getElementById("addBoxBtn");
  const boxSelect = document.getElementById("boxSelect");
  const wordInput = document.getElementById("wordInput");
  const addWordBtn = document.getElementById("addWordBtn");
  const statusSpan = document.getElementById("status");
  const boxChecks = document.getElementById("boxChecks");
  const startQuizBtn = document.getElementById("startQuizBtn");
  const showListBtn = document.getElementById("showListBtn");
  const wordListDiv = document.getElementById("wordList");
  const questionH3 = document.getElementById("question");
  const choicesDiv = document.getElementById("choices");
  const resultP = document.getElementById("result");

  /* ===== データ ===== */
  let data = JSON.parse(localStorage.getItem("wordData")) || {};
  const save = () =>
    localStorage.setItem("wordData", JSON.stringify(data));

  /* ===== 翻訳 ===== */
  async function translate(word) {
    const res = await fetch(
      "https://api.mymemory.translated.net/get?q=" +
      encodeURIComponent(word) +
      "&langpair=en|ja"
    );
    const json = await res.json();
    return json.responseData.translatedText || "（翻訳失敗）";
  }

  /* ===== UI更新 ===== */
  function updateUI() {
    boxSelect.innerHTML = "";
    boxChecks.innerHTML = "";
    for (const b in data) {
      boxSelect.add(new Option(b, b));
      const label = document.createElement("label");
      label.innerHTML = `<input type="checkbox" value="${b}">${b}`;
      boxChecks.appendChild(label);
      boxChecks.appendChild(document.createElement("br"));
    }
  }
  updateUI();

  /* ===== ボックス追加 ===== */
  addBoxBtn.onclick = () => {
    const name = boxNameInput.value.trim();
    if (!name || data[name]) return;
    data[name] = {};
    save();
    updateUI();
    boxNameInput.value = "";
  };

  /* ===== 単語登録 ===== */
  addWordBtn.onclick = async () => {
    const box = boxSelect.value;
    if (!box) return;
    const words = wordInput.value.split("\n")
      .map(w => w.trim()).filter(Boolean);
    if (!words.length) return;

    statusSpan.textContent = "翻訳中…";
    for (const w of words) {
      if (data[box][w]) continue;
      const meaning = await translate(w);
      data[box][w] = { meaning, history: [] };
      save();
    }
    statusSpan.textContent = "登録完了";
    wordInput.value = "";
  };

  /* ===== 一覧 ===== */
  showListBtn.onclick = () => {
    wordListDiv.innerHTML = "";
    for (const b in data) {
      wordListDiv.innerHTML += `<h3>${b}</h3>`;
      for (const w in data[b]) {
        const h = data[b][w].history.slice(-5)
          .map(x => x ? "⭕" : "❌").join("");
        wordListDiv.innerHTML +=
          `${w} :
          <input value="${data[b][w].meaning}"
          onchange="this.dataset.changed=1">
          ${h}<br>`;
      }
    }
  };

  /* ===== クイズ ===== */
  let quiz = [], wrong = [], idx = 0, correct = "";

  startQuizBtn.onclick = () => {
    let pool = [];
    document.querySelectorAll("#boxChecks input:checked")
      .forEach(c => {
        for (const w in data[c.value])
          pool.push({ box: c.value, word: w });
      });
    if (pool.length < 10) {
      alert("10語以上選択してください");
      return;
    }
    quiz = pool.sort(() => Math.random() - 0.5).slice(0, 10);
    wrong = [];
    idx = 0;
    nextQ();
  };

  function nextQ() {
    resultP.textContent = "";
    if (idx >= quiz.length) {
      if (wrong.length) {
        alert("間違えた問題をもう一度出します");
        quiz = wrong;
        wrong = [];
        idx = 0;
        nextQ();
      } else {
        alert("終了！");
      }
      return;
    }
    const q = quiz[idx];
    correct = data[q.box][q.word].meaning;

    let choices = [correct];
    for (const b in data)
      for (const w in data[b])
        if (choices.length < 4 && data[b][w].meaning !== correct)
          choices.push(data[b][w].meaning);

    choices = choices.sort(() => Math.random() - 0.5);

    questionH3.textContent =
      `(${idx + 1}) ${q.word} の意味は？`;
    choicesDiv.innerHTML = "";

    choices.forEach(c => {
      const btn = document.createElement("button");
      btn.textContent = c;
      btn.onclick = () => answer(c);
      choicesDiv.appendChild(btn);
    });
  }

  function answer(a) {
    const q = quiz[idx];
    const ok = a === correct;
    data[q.box][q.word].history.push(ok);
    if (!ok) wrong.push(q);
    save();
    resultP.textContent = ok ? "⭕ 正解" : "❌ 不正解";
    idx++;
    setTimeout(nextQ, 700);
  }

});
</script>

</body>
</html>
