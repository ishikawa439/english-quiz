<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>英単語クイズ（カスタム単語帳）</title>
<style>
body { font-family: sans-serif; max-width: 900px; margin: auto; }
section { border: 1px solid #ccc; padding: 10px; margin-bottom: 20px; }
input, button, select { margin: 3px; }
.choice button { display: block; width: 100%; margin: 4px 0; }
.history span { margin-right: 4px; }
</style>
</head>
<body>

<h1>英単語クイズ</h1>

<section>
<h2>① ボックス作成</h2>
<input id="newBoxName" placeholder="ボックス名">
<button onclick="addBox()">ボックス追加</button>
</section>

<section>
<h2>② 単語登録</h2>
<select id="boxSelect"></select><br>
英単語：<input id="newWord">
日本語訳：<input id="newMeaning">
<button onclick="addWord()">登録</button>
</section>

<section>
<h2>③ 出題範囲選択</h2>
<div id="boxChecks"></div>
<button onclick="startQuiz()">クイズ開始</button>
</section>

<section>
<h2>④ 単語一覧・編集・履歴</h2>
<button onclick="showWordList()">一覧を表示</button>
<div id="wordList"></div>
</section>

<section>
<h2>⑤ クイズ</h2>
<h3 id="question"></h3>
<div class="choice" id="choices"></div>
<p id="result"></p>
</section>

<script>
let data = JSON.parse(localStorage.getItem("wordData")) || {};

function save() {
  localStorage.setItem("wordData", JSON.stringify(data));
}

function addBox() {
  const name = newBoxName.value.trim();
  if (!name || data[name]) return;
  data[name] = {};
  save();
  updateUI();
  newBoxName.value = "";
}

function addWord() {
  const box = boxSelect.value;
  const w = newWord.value.trim();
  const m = newMeaning.value.trim();
  if (!box || !w || !m) return;
  data[box][w] = { meaning: m, history: [] };
  save();
  newWord.value = newMeaning.value = "";
}

function updateUI() {
  boxSelect.innerHTML = "";
  boxChecks.innerHTML = "";
  for (let b in data) {
    boxSelect.innerHTML += `<option>${b}</option>`;
    boxChecks.innerHTML += `<label>
      <input type="checkbox" value="${b}">${b}
    </label><br>`;
  }
}
updateUI();

function showWordList() {
  const area = wordList;
  area.innerHTML = "";
  for (let b in data) {
    area.innerHTML += `<h3>${b}</h3>`;
    for (let w in data[b]) {
      const h = data[b][w].history.slice(-5).map(x=>x?"⭕":"❌").join("");
      area.innerHTML += `
      ${w} :
      <input value="${data[b][w].meaning}"
        onchange="editMeaning('${b}','${w}',this.value)">
      <span class="history">${h}</span><br>`;
    }
  }
}

function editMeaning(b,w,v) {
  data[b][w].meaning = v;
  save();
}

// ===== クイズ =====
let quiz=[], wrong=[], idx=0, correct="";

function startQuiz() {
  let pool=[];
  document.querySelectorAll("#boxChecks input:checked")
    .forEach(c=>{
      for (let w in data[c.value]) {
        pool.push({box:c.value, word:w});
      }
    });
  if (pool.length<10) return alert("10語以上必要です");
  quiz = shuffle(pool).slice(0,10);
  wrong=[];
  idx=0;
  nextQ();
}

function nextQ() {
  result.textContent="";
  if (idx>=quiz.length) {
    if (wrong.length) {
      quiz=wrong; wrong=[]; idx=0;
      alert("間違えた問題をもう一度出します");
      nextQ();
    } else {
      alert("終了！");
    }
    return;
  }
  const q=quiz[idx];
  const item=data[q.box][q.word];
  correct=item.meaning;
  let choices=[correct];
  for (let b in data)
    for (let w in data[b])
      if (choices.length<4 && data[b][w].meaning!==correct)
        choices.push(data[b][w].meaning);
  choices=shuffle(choices);
  question.textContent=`(${idx+1}) ${q.word} の意味は？`;
  choicesDiv.innerHTML="";
  choices.forEach(c=>{
    const btn=document.createElement("button");
    btn.textContent=c;
    btn.onclick=()=>answer(c);
    choices.appendChild(btn);
  });
}

function answer(a) {
  const q=quiz[idx];
  const item=data[q.box][q.word];
  const ok=a===correct;
  item.history.push(ok);
  if (!ok) wrong.push(q);
  save();
  result.textContent=ok?"⭕ 正解":"❌ 不正解";
  idx++;
  setTimeout(nextQ,700);
}

function shuffle(a){return a.sort(()=>Math.random()-0.5);}
</script>

</body>
</html>
