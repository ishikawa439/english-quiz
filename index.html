<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>英単語クイズ（自動翻訳・一括登録対応）</title>
<style>
body { font-family: sans-serif; max-width: 900px; margin: auto; }
section { border: 1px solid #ccc; padding: 10px; margin-bottom: 20px; }
input, textarea, button, select { margin: 4px; }
textarea { width: 300px; height: 120px; }
.choice button { display: block; width: 100%; margin: 4px 0; }
.history { margin-left: 10px; }
</style>
</head>
<body>

<h1>英単語クイズ</h1>

<section>
<h2>① ボックス作成</h2>
<input id="newBoxName" placeholder="ボックス名">
<button id="addBoxBtn">追加</button>
</section>

<section>
<h2>② 単語登録（改行で複数OK）</h2>
<select id="boxSelect"></select><br>
<textarea id="newWords" placeholder="apple
run
important"></textarea><br>
<button id="addWordBtn">登録（自動翻訳）</button>
<span id="status"></span>
</section>

<section>
<h2>③ 出題範囲選択</h2>
<div id="boxChecks"></div>
<button id="startQuizBtn">クイズ開始</button>
</section>

<section>
<h2>④ 単語一覧・意味修正・履歴</h2>
<button id="showListBtn">一覧を表示</button>
<div id="wordList"></div>
</section>

<section>
<h2>⑤ クイズ</h2>
<h3 id="question"></h3>
<div class="choice" id="choices"></div>
<p id="result"></p>
</section>

<script>
// ===== 基本データ =====
let data = JSON.parse(localStorage.getItem("wordData")) || {};
const boxSelect = document.getElementById("boxSelect");
const boxChecks = document.getElementById("boxChecks");
const wordList = document.getElementById("wordList");
const choicesDiv = document.getElementById("choices");
const status = document.getElementById("status");

function save() {
  localStorage.setItem("wordData", JSON.stringify(data));
}

// ===== 翻訳 =====
async function translate(word) {
  const res = await fetch(
    `https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=en|ja`
  );
  const json = await res.json();
  return json.responseData.translatedText || "（翻訳失敗）";
}

// ===== UI更新 =====
function updateUI() {
  boxSelect.innerHTML = "";
  boxChecks.innerHTML = "";
  for (let b in data) {
    boxSelect.innerHTML += `<option>${b}</option>`;
    boxChecks.innerHTML +=
      `<label><input type="checkbox" value="${b}">${b}</label><br>`;
  }
}
updateUI();

// ===== ボックス追加 =====
document.getElementById("addBoxBtn").onclick = () => {
  const name = newBoxName.value.trim();
  if (!name || data[name]) return;
  data[name] = {};
  save();
  updateUI();
  newBoxName.value = "";
};

// ===== 単語一括登録 =====
document.getElementById("addWordBtn").onclick = async () => {
  const box = boxSelect.value;
  if (!box) return;

  const words = newWords.value
    .split("\n")
    .map(w => w.trim())
    .filter(w => w);

  if (!words.length) return;

  status.textContent = "翻訳中…";

  for (let w of words) {
    if (data[box][w]) continue;
    const meaning = await translate(w);
    data[box][w] = { meaning, history: [] };
    save();
  }

  status.textContent = "登録完了";
  newWords.value = "";
  setTimeout(() => status.textContent = "", 1500);
};

// ===== 一覧表示 =====
document.getElementById("showListBtn").onclick = () => {
  wordList.innerHTML = "";
  for (let b in data) {
    wordList.innerHTML += `<h3>${b}</h3>`;
    for (let w in data[b]) {
      const h = data[b][w].history.slice(-5)
        .map(x => x ? "⭕" : "❌").join("");
      wordList.innerHTML += `
        ${w} :
        <input value="${data[b][w].meaning}"
          onchange="data['${b}']['${w}'].meaning=this.value;save();">
        <span class="history">${h}</span><br>`;
    }
  }
};

// ===== クイズ =====
let quiz = [], wrong = [], idx = 0, correct = "";

document.getElementById("startQuizBtn").onclick = () => {
  let pool = [];
  document.querySelectorAll("#boxChecks input:checked").forEach(c => {
    for (let w in data[c.value]) {
      pool.push({ box: c.value, word: w });
    }
  });

  if (pool.length < 10) {
    alert("10語以上
